<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Highcharts多图联动实现及优化 | Sansen Sekai</title>
    <meta name="description" content="三千世界, 学无止境">
    <link rel="shortcut icon" type="image/x-icon" href="./public/sad-me.png">
    
    <link rel="preload" href="/assets/css/0.styles.56fe4379.css" as="style"><link rel="preload" href="/assets/js/app.3b644823.js" as="script"><link rel="preload" href="/assets/js/2.e997199f.js" as="script"><link rel="preload" href="/assets/js/27.4d3bdc40.js" as="script"><link rel="prefetch" href="/assets/js/10.5ee0a82c.js"><link rel="prefetch" href="/assets/js/11.daee2873.js"><link rel="prefetch" href="/assets/js/12.8248456d.js"><link rel="prefetch" href="/assets/js/13.54a5dd4a.js"><link rel="prefetch" href="/assets/js/14.b823f735.js"><link rel="prefetch" href="/assets/js/15.d3b5d7cb.js"><link rel="prefetch" href="/assets/js/16.be4ba155.js"><link rel="prefetch" href="/assets/js/17.c61f081b.js"><link rel="prefetch" href="/assets/js/18.27973658.js"><link rel="prefetch" href="/assets/js/19.12894926.js"><link rel="prefetch" href="/assets/js/20.b2251d91.js"><link rel="prefetch" href="/assets/js/21.9368ff97.js"><link rel="prefetch" href="/assets/js/22.c5dd3b56.js"><link rel="prefetch" href="/assets/js/23.823a011e.js"><link rel="prefetch" href="/assets/js/24.133dc402.js"><link rel="prefetch" href="/assets/js/25.908d76af.js"><link rel="prefetch" href="/assets/js/26.50ae55c2.js"><link rel="prefetch" href="/assets/js/28.1910ec53.js"><link rel="prefetch" href="/assets/js/29.ae3971d2.js"><link rel="prefetch" href="/assets/js/3.8119daf4.js"><link rel="prefetch" href="/assets/js/30.a266a056.js"><link rel="prefetch" href="/assets/js/31.6e1332a3.js"><link rel="prefetch" href="/assets/js/32.d43f6148.js"><link rel="prefetch" href="/assets/js/33.9f60066d.js"><link rel="prefetch" href="/assets/js/34.89e76bff.js"><link rel="prefetch" href="/assets/js/35.976d89b0.js"><link rel="prefetch" href="/assets/js/36.70cb64a6.js"><link rel="prefetch" href="/assets/js/37.5a73ef0e.js"><link rel="prefetch" href="/assets/js/38.c74c2711.js"><link rel="prefetch" href="/assets/js/39.8e716e3c.js"><link rel="prefetch" href="/assets/js/4.5292c871.js"><link rel="prefetch" href="/assets/js/40.64191991.js"><link rel="prefetch" href="/assets/js/41.118c8402.js"><link rel="prefetch" href="/assets/js/42.7c764675.js"><link rel="prefetch" href="/assets/js/43.6cade1e6.js"><link rel="prefetch" href="/assets/js/44.615aeebf.js"><link rel="prefetch" href="/assets/js/45.acfd3be9.js"><link rel="prefetch" href="/assets/js/46.5e409128.js"><link rel="prefetch" href="/assets/js/5.69e3b9fc.js"><link rel="prefetch" href="/assets/js/6.36a28e4b.js"><link rel="prefetch" href="/assets/js/7.708932b7.js"><link rel="prefetch" href="/assets/js/8.288108ab.js"><link rel="prefetch" href="/assets/js/9.377be857.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56fe4379.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Sansen Sekai</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/essay/" class="nav-link router-link-active">技术杂文</a></div><div class="nav-item"><a href="/base/" class="nav-link">基础知识</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法解析</a></div><div class="nav-item"><a href="https://github.com/sad-xu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/essay/" class="nav-link router-link-active">技术杂文</a></div><div class="nav-item"><a href="/base/" class="nav-link">基础知识</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法解析</a></div><div class="nav-item"><a href="https://github.com/sad-xu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/essay/" class="sidebar-link">技术杂文</a></li><li><a href="/essay/canvas的艺术.html" class="sidebar-link">canvas的艺术</a></li><li><a href="/essay/纯CSS实现酷炫文字效果.html" class="sidebar-link">纯CSS实现酷炫文字效果</a></li><li><a href="/essay/Highcharts多图联动实现及优化.html" class="active sidebar-link">Highcharts多图联动实现及优化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/essay/导出图片和excel实践.html" class="sidebar-link">导出图片和Excel实践</a></li><li><a href="/essay/Highcharts矩形树图的自定义布局方法.html" class="sidebar-link">Highcharts矩形树图的自定义布局方法</a></li><li><a href="/essay/第一届缤纷-滨江前端技术沙龙总结与感想.html" class="sidebar-link">第一届缤纷-滨江前端技术沙龙总结与感想</a></li><li><a href="/essay/前端代码埋点实践（二）.html" class="sidebar-link">前端代码埋点实践（二）</a></li><li><a href="/essay/前端代码埋点实践.html" class="sidebar-link">前端代码埋点实践</a></li><li><a href="/essay/Rust系列（一）.html" class="sidebar-link">Rust系列（一）：从零开始</a></li><li><a href="/essay/Rust系列（二）.html" class="sidebar-link">Rust系列（二）</a></li><li><a href="/essay/初探Rust与WASM.html" class="sidebar-link">初试WASM与Rust</a></li><li><a href="/essay/深度解析异步串行的4种实现及区别.html" class="sidebar-link">深度解析异步串行的4种实现及区别</a></li><li><a href="/essay/SVG图标在项目中的使用.html" class="sidebar-link">SVG图标在项目中的使用</a></li><li><a href="/essay/神策数据前端埋点源码解读.html" class="sidebar-link">神策数据前端埋点源码不完全解读</a></li><li><a href="/essay/vue-cli3移动端项目配置不完全指南.html" class="sidebar-link">vue-cli3移动端项目配置不完全指南</a></li><li><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html" class="sidebar-link">用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮</a></li><li><a href="/essay/Vue组件命令式和声明式的使用方式.html" class="sidebar-link">Vue组件命令式和声明式的使用方式</a></li><li><a href="/essay/优雅灵活的前端权限控制实践.html" class="sidebar-link">优雅灵活的前端权限控制实践</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="highcharts多图联动实现及优化"><a href="#highcharts多图联动实现及优化" class="header-anchor">#</a> Highcharts多图联动实现及优化</h1> <p>场景: 当前页面内有若干张图表，所有图表的x轴坐标均一致</p> <p>需求:</p> <ul><li>同步缩放 - 当对任一图表进行x轴缩放时，所有图表也会一起缩放</li> <li>同步鼠标位置 - 鼠标移至某一图中，所有图表的<code>准星线</code>均会随鼠标在图中的位置同步变化</li></ul> <p>针对以上需求，有一个官方实例<code>https://jshare.com.cn/temp/YOp6D7</code></p> <ol><li>解读示例实现方法</li> <li>分析示例的潜在问题和具体优化方案</li></ol> <h3 id="官方示例实现方法"><a href="#官方示例实现方法" class="header-anchor">#</a> 官方示例实现方法</h3> <p>首先，把所有图表的实例存到一个数组中</p> <p><code>allCharts = [chart1, chart2, ...]</code></p> <h4 id="同步缩放"><a href="#同步缩放" class="header-anchor">#</a> 同步缩放</h4> <p>同步缩放比较简单，就两点</p> <ul><li>A. 缩放事件 <code>xAxis.events.setExtremes</code></li> <li>B. 手动缩放坐标轴 <code>chart.xAxis[0].setExtremes(min, max, redraw, animation)</code></li></ul> <p>在缩放事件中对其他图表设置同样的范围
用户缩放 --&gt; 触发<code>A</code> -&gt; 对其余图表调用<code>B</code> --&gt; 被手动设置的图表均会触发<code>A</code></p> <p>以上会导致死循环
所以要区分用户缩放和<code>B</code>引起的缩放，只有在用户缩放触发的事件中才需要执行<code>B</code></p> <p>在<code>B</code>中追加标志</p> <p><code>chart.xAxis[0].setExtremes(min, max, redraw, animation, { trigger: 'syncExtremes' })</code></p> <p>同时在<code>A</code>的处理函数中增加判断逻辑 <code>if (e.trigger === 'syncExtremes')</code>
即可实现同步缩放</p> <h4 id="同步鼠标位置"><a href="#同步鼠标位置" class="header-anchor">#</a> 同步鼠标位置</h4> <p>添加<code>mousemove</code>事件 --&gt; 得到原生事件的<code>e</code> --&gt; 由<code>e</code>找到对应图表中的点<code>point</code> --&gt; 对<code>point</code>设置效果</p> <p>以下是官方示例的一段代码,关键点有三个</p> <div class="language-js extra-class"><pre class="language-js"><code>event <span class="token operator">=</span> chart<span class="token punctuation">.</span>pointer<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>originalEvent<span class="token punctuation">)</span> <span class="token comment">// 1.转换原生事件</span>
point <span class="token operator">=</span> chart<span class="token punctuation">.</span>series<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">searchPoint</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 2.寻找对应点</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">)</span> point<span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token comment">// 3.设置`point`效果</span>
</code></pre></div><p>在所有图表的外层<code>dom</code>上绑定了事件，触发时,对所有图表执行以上三步操作</p> <h3 id="官方示例潜在问题及优化"><a href="#官方示例潜在问题及优化" class="header-anchor">#</a> 官方示例潜在问题及优化</h3> <ol><li>定位不准</li></ol> <p>若用以上方法实现同步鼠标位置，则每个图表必须<code>竖直排列</code>且<code>首尾对齐</code></p> <p>若图表首尾不对齐或宽度又长又短，则会x轴同步不准</p> <p>若图表横向排列，则不会出现同步效果</p> <p>这是示例中最大的缺陷</p> <p>这时由于示例在事件处理中对每张图都执行了以上三步</p> <p>即所有图表寻找的对应点都是基于触发事件时的鼠标位置的X坐标，这是一种<code>视觉角度</code></p> <p>以鼠标位置为基准，画一条竖线</p> <p>示例只会保证每个图表的准星线都会和竖线重合，导致了以上的问题</p> <p>解决方法是需要从<code>数据角度</code>实现同步</p> <ul><li>A. 给每个图表绑定<code>mousemove</code>事件</li> <li>B. 通过<code>chart.pointer.normalize</code>和<code>chart.series[0].searchPoint</code>找到当前触发图表的<code>point</code></li> <li>C. 由<code>point</code>得到x轴实际坐标<code>x</code>，遍历其余图表实例在<code>chart.series[0].data</code>中根据<code>x</code>找到<code>point</code>，设置<code>point</code>效果</li></ul> <p>上述方法是靠实际的x轴坐标点实现的定位，可以保证同步时每个图都是同一个坐标
比起示例中每个图都要找点和转换，我的方法只要找一次，遍历只需要<code>find</code>即可，节省了大量开销</p> <ol start="2"><li>修改了原型方法</li></ol> <p>即同步鼠标位置的第三步</p> <div class="language-js extra-class"><pre class="language-js"><code>Highcharts<span class="token punctuation">.</span><span class="token class-name">Point</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">highlight</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onMouseOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 显示鼠标激活标识</span>
<span class="token punctuation">}</span>
</code></pre></div><p>修改原型方法会对该项目的所有图表产生影响，不应该随便改动
可将第三步改为</p> <div class="language-js extra-class"><pre class="language-js"><code>point<span class="token punctuation">.</span><span class="token function">onMouseOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>性能优化</li></ol> <p>实例中没有进行任何优化，但多图联动不可避免会出现大量数据的情况，而鼠标事件不可避免的频繁触发也容易导致性能问题</p> <p>下面将从两个角度谈一谈性能优化</p> <ul><li>配置</li></ul> <p>可以通过调整highcharts配置进行优化</p> <ol><li><p><code>chart.animation</code>
禁用动画效果，减少在渲染上花费的时间</p></li> <li><p><code>boost.useGPUTranslations</code>
启用GPU渲染，增加渲染速度</p></li> <li><p><code>dataGrouping</code>
当数据量较大时，会进行模糊处理，即相邻数据会合并
虽然会提高性能，但显示精度会明显下降，酌情使用</p></li></ol> <ul><li>js</li></ul> <p>同样的功能，换一种写法，性能可能会有质的提高</p> <p>针对js的优化首先是优化逻辑</p> <p>但在大量数据和图表的情况下，再怎么优化都有很大的计算量</p> <p>所以就需要欺骗一下人眼了</p> <p>将大块操作分割成n个小操作，即将大卡顿转化成n个小卡顿</p> <p>只要单个卡顿耗时小于16ms，对人来说就等于没有卡顿</p> <p>最开始把所有图表实例存在了一个数组里</p> <p>之后的许多操作需要遍历数组</p> <p>这里有两个影响性能的点：数组长度，单次执行时间</p> <p>假设单次执行耗时为<code>a</code>，数组长度为<code>b</code>，那么每次循环耗时则为<code>a*b</code></p> <p>如果按照一般操作，遍历数组的过程中页面是不会进行渲染的</p> <p>即每次循环会造成<code>a*b</code>的卡顿</p> <ol><li><code>setTimeout 0</code></li></ol> <p>这是<code>ECharts</code>开发者袁源在第三届VueConf中分享的小技巧
通过<code>setTimeout</code>0s让浏览器喘口气
将关键性的操作用<code>setTimeout</code>包起来</p> <ol start="2"><li>异步</li></ol> <p>可以把遍历里的操作转成异步，避免产生阻塞</p> <p>实际开发中往往是异步和<code>setTimeout</code>同时使用效果最佳</p> <p>唯一的副作用是当图表过多时同步效果会有零点几秒的先后差别，这也是没办法的事</p> <ul><li>设计</li></ul> <p>当用尽手段，效果还是不理想时,就要考虑一下需求的合理性了</p> <p>是否有必要展示这么多数据,大量的图表是否一定要一起展示，是否可以换一种展现方式</p> <p>前端在实现一个需求的时候往往要一人分饰三角</p> <p>开发：如何实现需求 --&gt; 如何更好的实现需求</p> <p>产品：为什么这样设计 --&gt; 有更好的设计方案吗</p> <p>用户：使用是否顺心 --&gt; 交互细节是否到位</p> <p>友情链接：</p> <ul><li><p><a href="https://jshare.com.cn/temp/YOp6D7" target="_blank" rel="noopener noreferrer">多图联动官方示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://www.yuque.com/vueconf/2019/blfy0p" target="_blank" rel="noopener noreferrer">袁源 - Vue开发ECharts踩坑指南演讲视频<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">修改于:</span> <span class="time">10/5/2019, 2:34:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/essay/纯CSS实现酷炫文字效果.html" class="prev">纯CSS实现酷炫文字效果</a></span> <span class="next"><a href="/essay/导出图片和excel实践.html">导出图片和Excel实践</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3b644823.js" defer></script><script src="/assets/js/2.e997199f.js" defer></script><script src="/assets/js/27.4d3bdc40.js" defer></script>
  </body>
</html>
