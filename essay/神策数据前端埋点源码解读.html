<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>神策数据前端埋点源码不完全解读 | Sansen Sekai</title>
    <meta name="description" content="三千世界, 学无止境">
    <link rel="shortcut icon" type="image/x-icon" href="./public/sad-me.png">
    
    <link rel="preload" href="/assets/css/0.styles.56fe4379.css" as="style"><link rel="preload" href="/assets/js/app.3b644823.js" as="script"><link rel="preload" href="/assets/js/2.e997199f.js" as="script"><link rel="preload" href="/assets/js/43.6cade1e6.js" as="script"><link rel="prefetch" href="/assets/js/10.5ee0a82c.js"><link rel="prefetch" href="/assets/js/11.daee2873.js"><link rel="prefetch" href="/assets/js/12.8248456d.js"><link rel="prefetch" href="/assets/js/13.54a5dd4a.js"><link rel="prefetch" href="/assets/js/14.b823f735.js"><link rel="prefetch" href="/assets/js/15.d3b5d7cb.js"><link rel="prefetch" href="/assets/js/16.be4ba155.js"><link rel="prefetch" href="/assets/js/17.c61f081b.js"><link rel="prefetch" href="/assets/js/18.27973658.js"><link rel="prefetch" href="/assets/js/19.12894926.js"><link rel="prefetch" href="/assets/js/20.b2251d91.js"><link rel="prefetch" href="/assets/js/21.9368ff97.js"><link rel="prefetch" href="/assets/js/22.c5dd3b56.js"><link rel="prefetch" href="/assets/js/23.823a011e.js"><link rel="prefetch" href="/assets/js/24.133dc402.js"><link rel="prefetch" href="/assets/js/25.908d76af.js"><link rel="prefetch" href="/assets/js/26.50ae55c2.js"><link rel="prefetch" href="/assets/js/27.4d3bdc40.js"><link rel="prefetch" href="/assets/js/28.1910ec53.js"><link rel="prefetch" href="/assets/js/29.ae3971d2.js"><link rel="prefetch" href="/assets/js/3.8119daf4.js"><link rel="prefetch" href="/assets/js/30.a266a056.js"><link rel="prefetch" href="/assets/js/31.6e1332a3.js"><link rel="prefetch" href="/assets/js/32.d43f6148.js"><link rel="prefetch" href="/assets/js/33.9f60066d.js"><link rel="prefetch" href="/assets/js/34.89e76bff.js"><link rel="prefetch" href="/assets/js/35.976d89b0.js"><link rel="prefetch" href="/assets/js/36.70cb64a6.js"><link rel="prefetch" href="/assets/js/37.5a73ef0e.js"><link rel="prefetch" href="/assets/js/38.c74c2711.js"><link rel="prefetch" href="/assets/js/39.8e716e3c.js"><link rel="prefetch" href="/assets/js/4.5292c871.js"><link rel="prefetch" href="/assets/js/40.64191991.js"><link rel="prefetch" href="/assets/js/41.118c8402.js"><link rel="prefetch" href="/assets/js/42.7c764675.js"><link rel="prefetch" href="/assets/js/44.615aeebf.js"><link rel="prefetch" href="/assets/js/45.acfd3be9.js"><link rel="prefetch" href="/assets/js/46.5e409128.js"><link rel="prefetch" href="/assets/js/5.69e3b9fc.js"><link rel="prefetch" href="/assets/js/6.36a28e4b.js"><link rel="prefetch" href="/assets/js/7.708932b7.js"><link rel="prefetch" href="/assets/js/8.288108ab.js"><link rel="prefetch" href="/assets/js/9.377be857.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56fe4379.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Sansen Sekai</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/essay/" class="nav-link router-link-active">技术杂文</a></div><div class="nav-item"><a href="/base/" class="nav-link">基础知识</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法解析</a></div><div class="nav-item"><a href="https://github.com/sad-xu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/essay/" class="nav-link router-link-active">技术杂文</a></div><div class="nav-item"><a href="/base/" class="nav-link">基础知识</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法解析</a></div><div class="nav-item"><a href="https://github.com/sad-xu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/essay/" class="sidebar-link">技术杂文</a></li><li><a href="/essay/canvas的艺术.html" class="sidebar-link">canvas的艺术</a></li><li><a href="/essay/纯CSS实现酷炫文字效果.html" class="sidebar-link">纯CSS实现酷炫文字效果</a></li><li><a href="/essay/Highcharts多图联动实现及优化.html" class="sidebar-link">Highcharts多图联动实现及优化</a></li><li><a href="/essay/导出图片和excel实践.html" class="sidebar-link">导出图片和Excel实践</a></li><li><a href="/essay/Highcharts矩形树图的自定义布局方法.html" class="sidebar-link">Highcharts矩形树图的自定义布局方法</a></li><li><a href="/essay/第一届缤纷-滨江前端技术沙龙总结与感想.html" class="sidebar-link">第一届缤纷-滨江前端技术沙龙总结与感想</a></li><li><a href="/essay/前端代码埋点实践（二）.html" class="sidebar-link">前端代码埋点实践（二）</a></li><li><a href="/essay/前端代码埋点实践.html" class="sidebar-link">前端代码埋点实践</a></li><li><a href="/essay/Rust系列（一）.html" class="sidebar-link">Rust系列（一）：从零开始</a></li><li><a href="/essay/Rust系列（二）.html" class="sidebar-link">Rust系列（二）</a></li><li><a href="/essay/初探Rust与WASM.html" class="sidebar-link">初试WASM与Rust</a></li><li><a href="/essay/深度解析异步串行的4种实现及区别.html" class="sidebar-link">深度解析异步串行的4种实现及区别</a></li><li><a href="/essay/SVG图标在项目中的使用.html" class="sidebar-link">SVG图标在项目中的使用</a></li><li><a href="/essay/神策数据前端埋点源码解读.html" class="active sidebar-link">神策数据前端埋点源码不完全解读</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/essay/神策数据前端埋点源码解读.html#_1-修改浏览器自带方法" class="sidebar-link">1. 修改浏览器自带方法</a></li><li class="sidebar-sub-header"><a href="/essay/神策数据前端埋点源码解读.html#_2-封装通用函数" class="sidebar-link">2. 封装通用函数</a></li><li class="sidebar-sub-header"><a href="/essay/神策数据前端埋点源码解读.html#_3-埋点代码" class="sidebar-link">3. 埋点代码</a></li><li class="sidebar-sub-header"><a href="/essay/神策数据前端埋点源码解读.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/essay/vue-cli3移动端项目配置不完全指南.html" class="sidebar-link">vue-cli3移动端项目配置不完全指南</a></li><li><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html" class="sidebar-link">用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮</a></li><li><a href="/essay/Vue组件命令式和声明式的使用方式.html" class="sidebar-link">Vue组件命令式和声明式的使用方式</a></li><li><a href="/essay/优雅灵活的前端权限控制实践.html" class="sidebar-link">优雅灵活的前端权限控制实践</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="神策数据前端埋点源码不完全解读"><a href="#神策数据前端埋点源码不完全解读" class="header-anchor">#</a> 神策数据前端埋点源码不完全解读</h1> <p><code>https://github.com/sensorsdata/sa-sdk-javascript/blob/master/sensorsdata.amd.min.js</code></p> <p>源码为压缩打包后的产物，都转为了ES5，美化后约2500行</p> <p>整体结构和jQuery的源码有点类似</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断是否支持 CommonJS 规范</span>
  <span class="token string">&quot;object&quot;</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> exports <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> module <span class="token operator">?</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 主体大致分三类</span>
    <span class="token comment">// 1. 修改浏览器自带方法 ≈ 100行</span>
    <span class="token comment">// 2. 封装通用函数 ≈ 1000行</span>
    <span class="token comment">// 3. 埋点代码 ≈ 1400行</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;object&quot;</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> console <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token keyword">try</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_1-修改浏览器自带方法"><a href="#_1-修改浏览器自带方法" class="header-anchor">#</a> 1. 修改浏览器自带方法</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Date</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toJSON
<span class="token class-name">Boolean</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toJSON 
<span class="token class-name">Number</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toJSON
<span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toJSON
<span class="token constant">JSON</span><span class="token punctuation">.</span>stringify
<span class="token constant">JSON</span><span class="token punctuation">.</span>parse
</code></pre></div><p>给<code>Date</code>，<code>Boolean</code>，<code>Number</code>，<code>String</code>新增了<code>toJSON</code>方法，内部返回的是<code>valueOf()</code>的值</p> <p>重写了<code>JSON</code>的序列化、反序列化方法，应该是为了兼容旧浏览器，似乎是用了<code>JSON2</code>的包，两者代码很像</p> <h2 id="_2-封装通用函数"><a href="#_2-封装通用函数" class="header-anchor">#</a> 2. 封装通用函数</h2> <p>共72个函数</p> <p>有部分是类似<code>lodash</code>里面的基础工具函数</p> <p>其他是一些对基础功能的封装，如<code>cookie</code>、<code>storage</code>、<code>ajax</code>、<code>url</code>、<code>DOM操作</code>等</p> <h2 id="_3-埋点代码"><a href="#_3-埋点代码" class="header-anchor">#</a> 3. 埋点代码</h2> <p>埋点的核心代码都在这里</p> <p>先看一下如何使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 初始化</span>
<span class="token function">requirejs</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;sensorsdata.amd.min&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sensors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//神策 SDK 初始化</span>
  sensors<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    server_url<span class="token punctuation">:</span> <span class="token string">'数据接收地址'</span><span class="token punctuation">,</span>
    heatmap<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 默认开启采集元素点击事件，not_collect 为关闭。</span>
      clickmap<span class="token punctuation">:</span><span class="token string">'default'</span><span class="token punctuation">,</span> 
      <span class="token comment">// 默认或者设置 default 开启采集元素点击事件，not_collect 为关闭。</span>
      scroll_notice_map<span class="token punctuation">:</span><span class="token string">'not_collect'</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>全埋点事件</p> <ol><li><p>$pageview 浏览页面</p> <p>调用<code>sensors.quick('autoTrack')</code> 方法触发</p></li> <li><p>$WebClick 元素点击</p> <p>a button input 被点击时触发</p> <p><code>heatmap:{clickmap:'default'}</code></p></li> <li><p>$WebStay 视区停留</p> <p>scroll 滚动时触发</p> <p><code>heatmap:{scroll_notice_map:'default'}</code></p></li></ol></li> <li><p>手动追踪事件</p> <p><code>sensors.track(event_name[, properties][, callback])</code></p></li></ul> <p>全埋点会收集以上三种类型的事件：页面访问、元素点击和视区停留，无论哪种事件，都会通过<code>sensors.track</code>收集数据发送</p> <p>下面来一个个分析它们的实现方式</p> <h3 id="pageview"><a href="#pageview" class="header-anchor">#</a> $pageview</h3> <p>在之前的埋点实践中，由于是单页面的Vue项目，可以很方便的在导航守卫里获取路由变化，而神策的埋点代码是通用式的框架无关的，所以需要考虑是单页面还是多页面，hash模式还是history模式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 一下是执行过程</span>
sensors<span class="token punctuation">.</span><span class="token function">quick</span><span class="token punctuation">(</span><span class="token string">'autoTrack'</span><span class="token punctuation">)</span>
<span class="token comment">// </span>
commonWays<span class="token punctuation">.</span><span class="token function">autoTrack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// track当前页面的$pageview数据</span>
sd<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span><span class="token string">&quot;$pageview&quot;</span><span class="token punctuation">,</span> _<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  $referrer<span class="token punctuation">:</span> _<span class="token punctuation">.</span><span class="token function">getReferrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 即document.referrer</span>
  $url<span class="token punctuation">:</span> location<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
  $url_path<span class="token punctuation">:</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span>
  $title<span class="token punctuation">:</span> document<span class="token punctuation">.</span>title
<span class="token punctuation">}</span>
<span class="token comment">// 若为单页面应用，绑定路由变化事件</span>
<span class="token comment">// 若支持history模式则监听popstate</span>
<span class="token comment">// 否则监听hashchange事件</span>
<span class="token string">&quot;pushState&quot;</span> <span class="token keyword">in</span> window<span class="token punctuation">.</span>history <span class="token operator">?</span> <span class="token string">&quot;popstate&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;hashchange&quot;</span>
<span class="token comment">// 事件触发时还是track以上页面信息</span>
</code></pre></div><p>本质上和vue-router的路由守卫原理相同，没啥可说的</p> <h3 id="webclick"><a href="#webclick" class="header-anchor">#</a> $WebClick</h3> <p>默认只采集<code>a</code>,<code>input</code>,<code>button</code>三种元素的事件，若要拓展则需要手动绑定</p> <p>相关代码在<code>heatmap.initHeatmap()</code>里</p> <p>绑定<code>document</code>的<code>click</code>事件，根据<code>tagName</code>过滤，执行<code>heatmap.start()</code>，在里面<code>track</code>当前事件信息</p> <p>原理很基础，就是绑定点击事件，过滤出需要的事件，收集事件携带的信息</p> <h3 id="webstay"><a href="#webstay" class="header-anchor">#</a> $WebStay</h3> <p>视区停留事件<code>heatmap.initScrollmap()</code></p> <p>绑定了两个事件<code>scroll</code>和<code>unload</code></p> <p>滚动时，有1s的debounce</p> <p>滚动结束后的时间 - 上次记录的时间 = 视区停留时间($scroll_event_duration)</p> <p>默认停留时间大于4s且滚动后位置变化了才会记录，且<code>scroll_event_duration</code>最大不超过18000秒</p> <p>最后更新上次记录时间，<code>track</code>数据</p> <p>在页面关闭前，需要收集关闭前的停留数据，所以需要绑定<code>unload</code>事件，除了该事件是立即执行的之外，其他和上面一样</p> <p>但其实他们这种收集并不是很准，页面不可见时的事件就没有减掉，还有长时间无动作时的判断。可能这方面的数据对数据分析并没有很大的影响，也可能这些情况属于小概率事件，可以忽略，或者这也属于正常操作的范畴，总之他们不处理肯定是有一定道理的。</p> <h3 id="sd-track"><a href="#sd-track" class="header-anchor">#</a> sd.track</h3> <p>所有收集到的数据都要通过<code>sd.track</code>来处理和发送，其内部有两步</p> <div class="language-js extra-class"><pre class="language-js"><code>saEvent<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  event<span class="token punctuation">:</span> e<span class="token punctuation">,</span>
  properties<span class="token punctuation">:</span> t
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> saEvent<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">&quot;track&quot;</span><span class="token punctuation">,</span>
  event<span class="token punctuation">:</span> e<span class="token punctuation">,</span>
  properties<span class="token punctuation">:</span> t
<span class="token punctuation">}</span>
</code></pre></div><p><code>saEvent.check</code>用来判断待发送的数据格式，<code>value</code>是否都是字符串</p> <p><code>saEvent.send</code>先对待发送数据再添加一些通用信息，如id、version什么的，在对这些信息做格式校验，还是蛮严谨的，数据准备完成，<code>sendState.getSendCall</code></p> <p>当页面是APP内的H5时，<code>use_app_track=true</code>数据可以通过<code>SensorsData_APP_JS_Bridge</code>发往APP，在APP里的SDK里统一处理，当出错后会构造一个iframe，往<code>sensorsanalytics://trackEvent?event=</code>发一个跨域请求，这其实是有点那个的，严格一点就属于数据泄露了。</p> <p>数据发送在<code>dataSend</code>类里，请求格式有三种<code>image</code>，<code>ajax</code>，<code>beacon</code>，默认第一种，后两种在不支持的情况下会切换为第一种。</p> <ul><li>image</li></ul> <p>构造一个1像素的img标签，必要时添加跨域，给src赋值的那一刻即发送了数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>img<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>img<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">1</span>
sd<span class="token punctuation">.</span>para<span class="token punctuation">.</span>img_use_crossorigin <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>img<span class="token punctuation">.</span>crossOrigin <span class="token operator">=</span> <span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> e<span class="token punctuation">.</span>data
<span class="token keyword">this</span><span class="token punctuation">.</span>server_url <span class="token operator">=</span> dataSend<span class="token punctuation">.</span><span class="token function">getSendUrl</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>server_url<span class="token punctuation">,</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>server_url
</code></pre></div><ul><li>ajax</li></ul> <p>发了一个post请求，跨域且不携带cookie，不管成功失败都视为结束</p> <div class="language-js extra-class"><pre class="language-js"><code>_<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>server_url<span class="token punctuation">,</span>
  type<span class="token punctuation">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span>
  credentials<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>
  timeout<span class="token punctuation">:</span> sd<span class="token punctuation">.</span>para<span class="token punctuation">.</span>datasend_timeout<span class="token punctuation">,</span>
  cors<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">isEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">error</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">isEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>beacon</li></ul> <p>由于beacon没有回调，所以40ms后就视为结束</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>server_url<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">isEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>以上大致分析了神策数据前端埋点的全埋点和手动埋点的实现原理，其实原理都很简单，之所以要看他们的源码，是因为我想看看业内比较成熟的解决方案是怎么个样子，至于为什么选神策而不是百度统计等产品，其实是觉得神策这个名字酷酷的。</p> <p>以上方法适用于任何地方，但有些东西结合当前项目的框架能实现的更好，就比如上篇文章的<code>v-log</code>，可如果要实现<code>v-log</code>,就不是引入一个SDK那么方便的事了，只能说各有利弊。</p> <p>代码没开源，只能看手动美化后的压缩代码，代码压缩后有很多反人类的写法，不关键的变量名都成了a,b,c,d，各种三元运算符与或非多重嵌套，而且所有代码合在同一个文件里，分不清东南西北。不过从里面可以看出来，他们的代码逻辑还是比较清晰的，各个模块功能明确，外部依赖几乎没有，毕竟埋点本身就不是一个很复杂的功能，收集数据只是第一步，就像吃东西，拿到数据，相当于手把食物放到了嘴里，之后还有唾液的分解，经过食道到胃，在经过小肠大肠，最后拉出来，才算是走完了一个流程。前端需要做的不仅仅是收集食物放到嘴里，还需要做个展示台，把最后的屎展示给别人看，别人通过多个角度的观察，最后得出你昨天吃了金针菇这个结论，形成了一个闭环，这就是所谓的<code>有屎有终</code>。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">修改于:</span> <span class="time">10/19/2019, 9:25:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/essay/SVG图标在项目中的使用.html" class="prev">SVG图标在项目中的使用</a></span> <span class="next"><a href="/essay/vue-cli3移动端项目配置不完全指南.html">vue-cli3移动端项目配置不完全指南</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3b644823.js" defer></script><script src="/assets/js/2.e997199f.js" defer></script><script src="/assets/js/43.6cade1e6.js" defer></script>
  </body>
</html>
