<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮 | Sansen Sekai</title>
    <meta name="description" content="三千世界, 学无止境">
    <link rel="shortcut icon" type="image/x-icon" href="./public/sad-me.png">
    
    <link rel="preload" href="/assets/css/0.styles.56fe4379.css" as="style"><link rel="preload" href="/assets/js/app.3b644823.js" as="script"><link rel="preload" href="/assets/js/2.e997199f.js" as="script"><link rel="preload" href="/assets/js/42.7c764675.js" as="script"><link rel="prefetch" href="/assets/js/10.5ee0a82c.js"><link rel="prefetch" href="/assets/js/11.daee2873.js"><link rel="prefetch" href="/assets/js/12.8248456d.js"><link rel="prefetch" href="/assets/js/13.54a5dd4a.js"><link rel="prefetch" href="/assets/js/14.b823f735.js"><link rel="prefetch" href="/assets/js/15.d3b5d7cb.js"><link rel="prefetch" href="/assets/js/16.be4ba155.js"><link rel="prefetch" href="/assets/js/17.c61f081b.js"><link rel="prefetch" href="/assets/js/18.27973658.js"><link rel="prefetch" href="/assets/js/19.12894926.js"><link rel="prefetch" href="/assets/js/20.b2251d91.js"><link rel="prefetch" href="/assets/js/21.9368ff97.js"><link rel="prefetch" href="/assets/js/22.c5dd3b56.js"><link rel="prefetch" href="/assets/js/23.823a011e.js"><link rel="prefetch" href="/assets/js/24.133dc402.js"><link rel="prefetch" href="/assets/js/25.908d76af.js"><link rel="prefetch" href="/assets/js/26.50ae55c2.js"><link rel="prefetch" href="/assets/js/27.4d3bdc40.js"><link rel="prefetch" href="/assets/js/28.1910ec53.js"><link rel="prefetch" href="/assets/js/29.ae3971d2.js"><link rel="prefetch" href="/assets/js/3.8119daf4.js"><link rel="prefetch" href="/assets/js/30.a266a056.js"><link rel="prefetch" href="/assets/js/31.6e1332a3.js"><link rel="prefetch" href="/assets/js/32.d43f6148.js"><link rel="prefetch" href="/assets/js/33.9f60066d.js"><link rel="prefetch" href="/assets/js/34.89e76bff.js"><link rel="prefetch" href="/assets/js/35.976d89b0.js"><link rel="prefetch" href="/assets/js/36.70cb64a6.js"><link rel="prefetch" href="/assets/js/37.5a73ef0e.js"><link rel="prefetch" href="/assets/js/38.c74c2711.js"><link rel="prefetch" href="/assets/js/39.8e716e3c.js"><link rel="prefetch" href="/assets/js/4.5292c871.js"><link rel="prefetch" href="/assets/js/40.64191991.js"><link rel="prefetch" href="/assets/js/41.118c8402.js"><link rel="prefetch" href="/assets/js/43.6cade1e6.js"><link rel="prefetch" href="/assets/js/44.615aeebf.js"><link rel="prefetch" href="/assets/js/45.acfd3be9.js"><link rel="prefetch" href="/assets/js/46.5e409128.js"><link rel="prefetch" href="/assets/js/5.69e3b9fc.js"><link rel="prefetch" href="/assets/js/6.36a28e4b.js"><link rel="prefetch" href="/assets/js/7.708932b7.js"><link rel="prefetch" href="/assets/js/8.288108ab.js"><link rel="prefetch" href="/assets/js/9.377be857.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56fe4379.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Sansen Sekai</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/essay/" class="nav-link router-link-active">技术杂文</a></div><div class="nav-item"><a href="/base/" class="nav-link">基础知识</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法解析</a></div><div class="nav-item"><a href="https://github.com/sad-xu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/essay/" class="nav-link router-link-active">技术杂文</a></div><div class="nav-item"><a href="/base/" class="nav-link">基础知识</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法解析</a></div><div class="nav-item"><a href="https://github.com/sad-xu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/essay/" class="sidebar-link">技术杂文</a></li><li><a href="/essay/canvas的艺术.html" class="sidebar-link">canvas的艺术</a></li><li><a href="/essay/纯CSS实现酷炫文字效果.html" class="sidebar-link">纯CSS实现酷炫文字效果</a></li><li><a href="/essay/Highcharts多图联动实现及优化.html" class="sidebar-link">Highcharts多图联动实现及优化</a></li><li><a href="/essay/导出图片和excel实践.html" class="sidebar-link">导出图片和Excel实践</a></li><li><a href="/essay/Highcharts矩形树图的自定义布局方法.html" class="sidebar-link">Highcharts矩形树图的自定义布局方法</a></li><li><a href="/essay/第一届缤纷-滨江前端技术沙龙总结与感想.html" class="sidebar-link">第一届缤纷-滨江前端技术沙龙总结与感想</a></li><li><a href="/essay/前端代码埋点实践（二）.html" class="sidebar-link">前端代码埋点实践（二）</a></li><li><a href="/essay/前端代码埋点实践.html" class="sidebar-link">前端代码埋点实践</a></li><li><a href="/essay/Rust系列（一）.html" class="sidebar-link">Rust系列（一）：从零开始</a></li><li><a href="/essay/Rust系列（二）.html" class="sidebar-link">Rust系列（二）</a></li><li><a href="/essay/初探Rust与WASM.html" class="sidebar-link">初试WASM与Rust</a></li><li><a href="/essay/深度解析异步串行的4种实现及区别.html" class="sidebar-link">深度解析异步串行的4种实现及区别</a></li><li><a href="/essay/SVG图标在项目中的使用.html" class="sidebar-link">SVG图标在项目中的使用</a></li><li><a href="/essay/神策数据前端埋点源码解读.html" class="sidebar-link">神策数据前端埋点源码不完全解读</a></li><li><a href="/essay/vue-cli3移动端项目配置不完全指南.html" class="sidebar-link">vue-cli3移动端项目配置不完全指南</a></li><li><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html" class="active sidebar-link">用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html#cpu曲线" class="sidebar-link">CPU曲线</a></li><li class="sidebar-sub-header"><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html#控制cpu" class="sidebar-link">控制CPU</a></li><li class="sidebar-sub-header"><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html#画零部件" class="sidebar-link">画零部件</a></li><li class="sidebar-sub-header"><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html#组装" class="sidebar-link">组装</a></li><li class="sidebar-sub-header"><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/essay/Vue组件命令式和声明式的使用方式.html" class="sidebar-link">Vue组件命令式和声明式的使用方式</a></li><li><a href="/essay/优雅灵活的前端权限控制实践.html" class="sidebar-link">优雅灵活的前端权限控制实践</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="用js让cpu跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮"><a href="#用js让cpu跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮" class="header-anchor">#</a> 用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮</h1> <p>阿姆斯特朗回旋加速喷气式阿姆斯特朗炮的原型是阿姆斯特朗炮，阿姆斯特朗炮是由19世纪英国著名火炮专家Sir William Armstrong所建立的阿姆斯特朗公司所开发的一系列大中口径火炮。</p> <p>在《银魂》动画第38话中，阿姆斯特朗回旋加速喷气式阿姆斯特朗炮首次出现，作者在阿姆斯特朗炮的基础上在进行了艺术创作，变成了下面这个样子</p> <p>再将其抽象化，用线条描述，是由三个圆和一个矩形组成</p> <h2 id="cpu曲线"><a href="#cpu曲线" class="header-anchor">#</a> CPU曲线</h2> <p>这次我们要通过js让CPU跑出这个形状出来，由于电脑在正常使用中，有很多任务在运行，不可避免的会产生干扰，导致任务管理器里的CPU曲线很难看，所以我们通过浏览器自带的监控器来看CPU曲线</p> <p>打开Chrome浏览器，打开控制台，<code>more tools --&gt; Performance monitor</code>，这里只会监控当前页面的各种指标，隔离了外面的影响。</p> <p>CPU的曲线的x轴为时间，y轴为CPU使用率。一个x只对应一个y，所以理想中的曲线应该是这样的</p> <h2 id="控制cpu"><a href="#控制cpu" class="header-anchor">#</a> 控制CPU</h2> <p>那么问题来了，如何控制CPU的使用率</p> <p>相信大家都遇到过页面卡死的情况，在那个时候如果看一下CPU，那使用率肯定是100%左右，发生这种情况的原因一般都是出现了死循环,最简单的死循环就是<code>while(true) {}</code></p> <p>而我们什么都不做，即没有语句执行时，CPU的使用率则为0</p> <p>好了，现在已经找到了两个极端，至少已经能画出<code>y=0</code>和<code>y=100</code>两条线</p> <p>在计算机中，所有的一切都是离散值，CPU使用率图，本质上收集的是各个时刻的值，再用线连起来罢了</p> <p>假设一台电脑的CPU频率是2.4GHz，即每秒<code>2.4 * 10 ^ 9</code>个时钟周期，每个时钟周期至少能执行两条以上的代码，则每秒至少可以执行960000000条代码</p> <p>那是不是可以理解为如果真的有这么多代码，则一秒后会执行完，那这一秒的使用率则为100%</p> <p>如果只有一半的代码，在0.5秒的时候就执行完了，那这一秒的使用率则为50%</p> <p>所以我们可以通过控制一个很小的时间段内执行代码和不执行代码的时间占比来操控当前时间段里的统计结果</p> <p>执行代码可以通过死循环，但不执行代码如何实现，js里可没有<code>sleep</code>这种东西</p> <p>可是有异步哇！</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码先包了一层死循环，在每轮循环里，先执行100ms的死循环，接下来是一个异步函数，计时100ms后执行后面的代码，即进入下一轮循环</p> <p>放到浏览器里跑一下</p> <p>是波浪形，而不是预想中的直线，因为跑100ms歇100ms，一个周期其实是200ms，如果浏览器的统计精度是120ms，那么第一轮的占比是100/120=83%，第二轮则是40/120=33%。调成50ms试试</p> <p>完美</p> <h2 id="画零部件"><a href="#画零部件" class="header-anchor">#</a> 画零部件</h2> <p>控制CPU使用率已经可以通过调整死循环时间和异步时间的比例来实现，下面就是怎样设置这个比例了</p> <p>我们可以生成两个数组<code>busyArr</code>、<code>idleArr</code>，分别存放循环和异步时间列表</p> <p>在分析一下阿姆斯特朗回旋加速喷气式阿姆斯特朗炮的图，好像还可以再简化一下</p> <p>实际需要的就只有这三个半圆的数据，其中下面两个可以看成同一个</p> <p>写一个生成半圆数据的函数，传入的参数需要考虑圆的半径，圆心的高度，以及生成数组的长度</p> <p>这里考虑把CPU的0%~100%映射为<code>[0,1]</code></p> <p>圆的方程为<code>(x-a)^2 + (y-b)^2 = r^2</code></p> <p>由图可知，<code>a</code>为<code>r</code>，<code>b</code>为<code>h</code>，<code>x</code>的范围是<code>[0, count]</code></p> <p>则<code>y=√(2*r*x - x^2) + h</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义一个周期为100ms</span>
<span class="token keyword">const</span> <span class="token constant">PIECE</span> <span class="token operator">=</span> <span class="token number">100</span>

<span class="token keyword">function</span> <span class="token function">getCircleArr</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  h <span class="token operator">=</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
  r <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
  count <span class="token operator">=</span> <span class="token number">25</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> busyArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> idleArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> dx <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> r <span class="token operator">/</span> count
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> dx <span class="token operator">*</span> i
    <span class="token keyword">let</span> v <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> r <span class="token operator">*</span> x <span class="token operator">-</span> x <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">+</span> h
    busyArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">PIECE</span> <span class="token operator">*</span> v<span class="token punctuation">)</span>
    idleArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">PIECE</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    busyArr<span class="token punctuation">,</span>
    idleArr
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>先试一下，这里在页面里加了个按钮来触发</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> busyArr<span class="token punctuation">,</span> idleArr <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getCircleArr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> busyArr<span class="token punctuation">.</span>length
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 画完后就退出死循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> count<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> n <span class="token operator">&lt;</span> busyArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> idleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    i<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'startButton'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Emmmmm，马马虎虎吧，看起来有点坑坑洼洼的，原因可能有两个，一是代码里有一些其他操作比如获取时间、声明异步、定时等，或多或少有点影响，二是各个浏览器为了让自己比其他浏览器快，不知道加了多少黑科技，图上的曲线凹下去的比较多，说明CPU的消耗比我们想象中的要少。这两点都没法避免。</p> <h2 id="组装"><a href="#组装" class="header-anchor">#</a> 组装</h2> <p>下面来画另外的半圆，再拼接起来</p> <p>关于圆的尺寸，多试试就好</p> <p>而数组的长度，这和周期<code>PIECE</code>都会影响图的宽度，也是自己多调调</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">assembleCannon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> bottom <span class="token operator">=</span> <span class="token function">getCircleArr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> top <span class="token operator">=</span> <span class="token function">getCircleArr</span><span class="token punctuation">(</span><span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span> r<span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    busyArr<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>bottom<span class="token punctuation">.</span>busyArr<span class="token punctuation">,</span> <span class="token operator">...</span>top<span class="token punctuation">.</span>busyArr<span class="token punctuation">,</span> <span class="token operator">...</span>bottom<span class="token punctuation">.</span>busyArr<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    idleArr<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>bottom<span class="token punctuation">.</span>idleArr<span class="token punctuation">,</span> <span class="token operator">...</span>top<span class="token punctuation">.</span>idleArr<span class="token punctuation">,</span> <span class="token operator">...</span>bottom<span class="token punctuation">.</span>idleArr<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>赶紧跑一下看看</p> <p>为什么这么丑啊</p> <p>在连接处如果有点凹可能会更好一点，把<code>getCircleArr</code>生成的数组的边界稍微复制些值</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// getCircleArr</span>
<span class="token operator">...</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  busyArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>busyArr<span class="token punctuation">[</span>busyArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  busyArr<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>busyArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  idleArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>idleArr<span class="token punctuation">[</span>idleArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  idleArr<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>idleArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>看看</p> <p>这就是阿姆斯特朗回旋加速喷气式阿姆斯特朗炮吗，复原度还真高呢。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>代码不多，也不难，关键点就是用异步来实现<code>sleep</code></p> <p>幸好Chrome带了监控，如果用系统自带的，那结果简直惨不忍睹</p> <p>下面是完整代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 每片 busy + idle 时间</span>
<span class="token keyword">const</span> <span class="token constant">PIECE</span> <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">// 圆 [0, 1]</span>
<span class="token comment">// 圆心 (r, h) 半径 r</span>
<span class="token comment">// (x - r)^2 + (y - h)^2 = r^2</span>
<span class="token keyword">function</span> <span class="token function">getCircleArr</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  h <span class="token operator">=</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
  r <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
  count <span class="token operator">=</span> <span class="token number">25</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> busyArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> idleArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> dx <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> r <span class="token operator">/</span> count
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> dx <span class="token operator">*</span> i
    <span class="token keyword">let</span> v <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> r <span class="token operator">*</span> x <span class="token operator">-</span> x <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">+</span> h
    busyArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">PIECE</span> <span class="token operator">*</span> v<span class="token punctuation">)</span>
    idleArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">PIECE</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    busyArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>busyArr<span class="token punctuation">[</span>busyArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    busyArr<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>busyArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    idleArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>idleArr<span class="token punctuation">[</span>idleArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    idleArr<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>idleArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    busyArr<span class="token punctuation">,</span>
    idleArr
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 组装</span>
<span class="token keyword">function</span> <span class="token function">assembleCannon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> bottom <span class="token operator">=</span> <span class="token function">getCircleArr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> top <span class="token operator">=</span> <span class="token function">getCircleArr</span><span class="token punctuation">(</span><span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span> r<span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    busyArr<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>bottom<span class="token punctuation">.</span>busyArr<span class="token punctuation">,</span> <span class="token operator">...</span>top<span class="token punctuation">.</span>busyArr<span class="token punctuation">,</span> <span class="token operator">...</span>bottom<span class="token punctuation">.</span>busyArr<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    idleArr<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>bottom<span class="token punctuation">.</span>idleArr<span class="token punctuation">,</span> <span class="token operator">...</span>top<span class="token punctuation">.</span>idleArr<span class="token punctuation">,</span> <span class="token operator">...</span>bottom<span class="token punctuation">.</span>idleArr<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// let { busyArr, idleArr } = initSinData()</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> busyArr<span class="token punctuation">,</span> idleArr <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">assembleCannon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// let { busyArr, idleArr } = getCircleArr()</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>busyArr<span class="token punctuation">,</span> idleArr<span class="token punctuation">)</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> busyArr<span class="token punctuation">.</span>length
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> count<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> n <span class="token operator">&lt;</span> busyArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> idleArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    i<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'startButton'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">修改于:</span> <span class="time">12/12/2019, 8:36:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/essay/vue-cli3移动端项目配置不完全指南.html" class="prev">vue-cli3移动端项目配置不完全指南</a></span> <span class="next"><a href="/essay/Vue组件命令式和声明式的使用方式.html">Vue组件命令式和声明式的使用方式</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3b644823.js" defer></script><script src="/assets/js/2.e997199f.js" defer></script><script src="/assets/js/42.7c764675.js" defer></script>
  </body>
</html>
