<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>导出图片和Excel实践 | Sansen Sekai</title>
    <meta name="description" content="三千世界, 学无止境">
    <link rel="shortcut icon" type="image/x-icon" href="./public/sad-me.png">
    
    <link rel="preload" href="/assets/css/0.styles.56fe4379.css" as="style"><link rel="preload" href="/assets/js/app.3b644823.js" as="script"><link rel="preload" href="/assets/js/2.e997199f.js" as="script"><link rel="preload" href="/assets/js/40.64191991.js" as="script"><link rel="prefetch" href="/assets/js/10.5ee0a82c.js"><link rel="prefetch" href="/assets/js/11.daee2873.js"><link rel="prefetch" href="/assets/js/12.8248456d.js"><link rel="prefetch" href="/assets/js/13.54a5dd4a.js"><link rel="prefetch" href="/assets/js/14.b823f735.js"><link rel="prefetch" href="/assets/js/15.d3b5d7cb.js"><link rel="prefetch" href="/assets/js/16.be4ba155.js"><link rel="prefetch" href="/assets/js/17.c61f081b.js"><link rel="prefetch" href="/assets/js/18.27973658.js"><link rel="prefetch" href="/assets/js/19.12894926.js"><link rel="prefetch" href="/assets/js/20.b2251d91.js"><link rel="prefetch" href="/assets/js/21.9368ff97.js"><link rel="prefetch" href="/assets/js/22.c5dd3b56.js"><link rel="prefetch" href="/assets/js/23.823a011e.js"><link rel="prefetch" href="/assets/js/24.133dc402.js"><link rel="prefetch" href="/assets/js/25.908d76af.js"><link rel="prefetch" href="/assets/js/26.50ae55c2.js"><link rel="prefetch" href="/assets/js/27.4d3bdc40.js"><link rel="prefetch" href="/assets/js/28.1910ec53.js"><link rel="prefetch" href="/assets/js/29.ae3971d2.js"><link rel="prefetch" href="/assets/js/3.8119daf4.js"><link rel="prefetch" href="/assets/js/30.a266a056.js"><link rel="prefetch" href="/assets/js/31.6e1332a3.js"><link rel="prefetch" href="/assets/js/32.d43f6148.js"><link rel="prefetch" href="/assets/js/33.9f60066d.js"><link rel="prefetch" href="/assets/js/34.89e76bff.js"><link rel="prefetch" href="/assets/js/35.976d89b0.js"><link rel="prefetch" href="/assets/js/36.70cb64a6.js"><link rel="prefetch" href="/assets/js/37.5a73ef0e.js"><link rel="prefetch" href="/assets/js/38.c74c2711.js"><link rel="prefetch" href="/assets/js/39.8e716e3c.js"><link rel="prefetch" href="/assets/js/4.5292c871.js"><link rel="prefetch" href="/assets/js/41.118c8402.js"><link rel="prefetch" href="/assets/js/42.7c764675.js"><link rel="prefetch" href="/assets/js/43.6cade1e6.js"><link rel="prefetch" href="/assets/js/44.615aeebf.js"><link rel="prefetch" href="/assets/js/45.acfd3be9.js"><link rel="prefetch" href="/assets/js/46.5e409128.js"><link rel="prefetch" href="/assets/js/5.69e3b9fc.js"><link rel="prefetch" href="/assets/js/6.36a28e4b.js"><link rel="prefetch" href="/assets/js/7.708932b7.js"><link rel="prefetch" href="/assets/js/8.288108ab.js"><link rel="prefetch" href="/assets/js/9.377be857.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56fe4379.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Sansen Sekai</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/essay/" class="nav-link router-link-active">技术杂文</a></div><div class="nav-item"><a href="/base/" class="nav-link">基础知识</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法解析</a></div><div class="nav-item"><a href="https://github.com/sad-xu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/essay/" class="nav-link router-link-active">技术杂文</a></div><div class="nav-item"><a href="/base/" class="nav-link">基础知识</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法解析</a></div><div class="nav-item"><a href="https://github.com/sad-xu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/essay/" class="sidebar-link">技术杂文</a></li><li><a href="/essay/canvas的艺术.html" class="sidebar-link">canvas的艺术</a></li><li><a href="/essay/纯CSS实现酷炫文字效果.html" class="sidebar-link">纯CSS实现酷炫文字效果</a></li><li><a href="/essay/Highcharts多图联动实现及优化.html" class="sidebar-link">Highcharts多图联动实现及优化</a></li><li><a href="/essay/导出图片和excel实践.html" class="active sidebar-link">导出图片和Excel实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/essay/导出图片和excel实践.html#准备" class="sidebar-link">准备</a></li><li class="sidebar-sub-header"><a href="/essay/导出图片和excel实践.html#loading" class="sidebar-link">Loading</a></li><li class="sidebar-sub-header"><a href="/essay/导出图片和excel实践.html#导出图片" class="sidebar-link">导出图片</a></li><li class="sidebar-sub-header"><a href="/essay/导出图片和excel实践.html#导出excel" class="sidebar-link">导出Excel</a></li><li class="sidebar-sub-header"><a href="/essay/导出图片和excel实践.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/essay/Highcharts矩形树图的自定义布局方法.html" class="sidebar-link">Highcharts矩形树图的自定义布局方法</a></li><li><a href="/essay/第一届缤纷-滨江前端技术沙龙总结与感想.html" class="sidebar-link">第一届缤纷-滨江前端技术沙龙总结与感想</a></li><li><a href="/essay/前端代码埋点实践（二）.html" class="sidebar-link">前端代码埋点实践（二）</a></li><li><a href="/essay/前端代码埋点实践.html" class="sidebar-link">前端代码埋点实践</a></li><li><a href="/essay/Rust系列（一）.html" class="sidebar-link">Rust系列（一）：从零开始</a></li><li><a href="/essay/Rust系列（二）.html" class="sidebar-link">Rust系列（二）</a></li><li><a href="/essay/初探Rust与WASM.html" class="sidebar-link">初试WASM与Rust</a></li><li><a href="/essay/深度解析异步串行的4种实现及区别.html" class="sidebar-link">深度解析异步串行的4种实现及区别</a></li><li><a href="/essay/SVG图标在项目中的使用.html" class="sidebar-link">SVG图标在项目中的使用</a></li><li><a href="/essay/神策数据前端埋点源码解读.html" class="sidebar-link">神策数据前端埋点源码不完全解读</a></li><li><a href="/essay/vue-cli3移动端项目配置不完全指南.html" class="sidebar-link">vue-cli3移动端项目配置不完全指南</a></li><li><a href="/essay/用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮.html" class="sidebar-link">用js让CPU跑出一个阿姆斯特朗回旋加速喷气式阿姆斯特朗炮</a></li><li><a href="/essay/Vue组件命令式和声明式的使用方式.html" class="sidebar-link">Vue组件命令式和声明式的使用方式</a></li><li><a href="/essay/优雅灵活的前端权限控制实践.html" class="sidebar-link">优雅灵活的前端权限控制实践</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="导出图片和excel实践"><a href="#导出图片和excel实践" class="header-anchor">#</a> 导出图片和Excel实践</h1> <p>在中后台网站中，导出图片和Excel是比较常用的功能，虽然好像也没什么人用...</p> <p>下面分别就图片和Excel讲解一下具体实现步骤</p> <h2 id="准备"><a href="#准备" class="header-anchor">#</a> 准备</h2> <p>导出图片需要用到<code>html2canvas</code>，导出Excel需要用到<code>xlsx</code>，由于两者都属于需要把文件存储到本地的操作，最好用<code>file-saver</code></p> <p>其实图片的导出可以后端来做，涉及到服务端渲染，但有局限性，如果涉及到用户的操作痕迹等，就只能前端做了</p> <p>记得以前Excel的导出都是由后端来做的，前端做的话可以减少一点服务器压力，但如果涉及到海量数据的话要么通过<code>web wroker</code>或<code>WSAM</code>优化，否则就只能后端做了</p> <h2 id="loading"><a href="#loading" class="header-anchor">#</a> Loading</h2> <p>导出功能作为一个比较独立的功能，最好放到<code>utils</code>文件夹里，如下</p> <div class="language-shell extra-class"><pre class="language-shell"><code>├─router
└─utils
    └─export
        ├─excel.js
        ├─img.js
        └─index.js
</code></pre></div><p>有些依赖很大，一开始也用不到，按需加载比较合适。而按需加载的时间比较久，就需要在加载时显示loading</p> <p>这里就会遇到一个问题</p> <p>我的loading是这样写的，绑在了Vue实例上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Loading <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'element-ui'</span>
<span class="token comment">// 1. 声明式，组件局部加载 v-loading</span>
<span class="token comment">// 2. 命令式，$showLoading $hideLoading 最短显隐间隔1s</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> directive<span class="token punctuation">:</span> loadingDirective<span class="token punctuation">,</span> service<span class="token punctuation">:</span> loadingService <span class="token punctuation">}</span> <span class="token operator">=</span> Loading
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>loadingDirective<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> <span class="token constant">LIMIT_TIME</span> <span class="token operator">=</span> <span class="token number">1000</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$showLoading <span class="token operator">=</span> <span class="token punctuation">(</span>option <span class="token operator">=</span> <span class="token punctuation">{</span>
    text<span class="token punctuation">:</span> <span class="token string">'加载中...'</span><span class="token punctuation">,</span>
    background<span class="token punctuation">:</span> <span class="token string">'rgba(242,242,242,0.5)'</span><span class="token punctuation">,</span>
    lock<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">loadingService</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$hideLoading</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_t <span class="token operator">&lt;</span> <span class="token constant">LIMIT_TIME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">loadingService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">LIMIT_TIME</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">loadingService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>而<code>utils</code>和<code>Vue实例</code>没有半毛钱关系，也就调不到loading</p> <p>解决方法有三种</p> <ol><li><p>把loading绑到window上，任何地方都能使用</p></li> <li><p>在<code>main.js</code>里把Vue实例<code>export</code>出去，在需要的地方引入，调它上面的方法</p></li> <li><p>把loading方法移到外面去，当作一个通用函数</p></li></ol> <p>显然第三种最合理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// utils/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> showLoading<span class="token punctuation">,</span> hideLoading <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils'</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$showLoading <span class="token operator">=</span> showLoading
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$hideLoading <span class="token operator">=</span> hideLoading
</code></pre></div><p>这个问题出现的主要原因是没有考虑到在非页面代码里调<code>loading</code>的情况，其次在<code>main.js</code>里写的那个IIFE一眼看上去就与其他代码格格不入，从代码的合理性上来说也是需要优化的。</p> <h2 id="导出图片"><a href="#导出图片" class="header-anchor">#</a> 导出图片</h2> <p>思路是先通过<code>html2canvas</code>把实际DOM转成canvas，再通过<code>file-saver</code>把canvas存成图片</p> <p>对外只要暴露一个函数<code>exportImg</code>，参数只需要一个需要转化的DOM对象，和一个可选的图片名</p> <p>这种方法导出的图片和截图类似，不过它可以无视屏幕限制，即可以生成超过屏幕尺寸的图片</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// export/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> showLoading<span class="token punctuation">,</span> hideLoading <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">exportImg</span><span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./img.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">exportFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// `hideLoading`的位置我这里放的比较早，因为loading至少有1秒，早点也没关系</span>
      <span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      exportFn<span class="token punctuation">.</span><span class="token function">exportHTMLToImg</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面之所以延时100ms，是因为里面的代码会阻塞loading的出现，在前文《Vue组件命令式和声明式的使用方式》中，可以知道<code>showLoading</code>也相当于一个组件，它可不是改个css显示隐藏就实现的，在它的源码里，有这样一行代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
parent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>$el<span class="token punctuation">)</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  instance<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><p>即loading实际的显示被包在了<code>nextTick</code>里，<code>nextTick</code>的实现则是promise或是setTimeout=0，如果当前同步任务过多，显示就会延后，看起来很糟糕，所以这里延时100毫秒其实是体验上的优化</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// export/img.js</span>
<span class="token keyword">import</span> html2canvas <span class="token keyword">from</span> <span class="token string">'html2canvas'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> saveAs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'file-saver'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">exportHTMLToImg</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token punctuation">,</span>
  name <span class="token operator">=</span> <span class="token string">'example'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">html2canvas</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    logging<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">canvas</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    canvas<span class="token punctuation">.</span><span class="token function">toBlob</span><span class="token punctuation">(</span><span class="token parameter">blob</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">saveAs</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>html2canvas</code>的配置不多，这里只把log去掉了，毕竟只是实现类似截图的功能。其他的诸如背景、宽高、剔除指定DOM等看情况使用，也可作为参数传入</p> <p>如果要实现导出pdf，可能需要配合<code>jsPDF</code>使用，没试过，不想试</p> <h2 id="导出excel"><a href="#导出excel" class="header-anchor">#</a> 导出Excel</h2> <p>这个功能在年初的时候实现过，当时使用的是<code>xlsx</code>，功能非常多，但是社区版不支持修改单元格样式</p> <p>有一个民间库<code>xlsx-style</code>基于<code>xlsx</code>拓展了修改样式的功能，但都好多年不维护了，部分样式像行高也不支持修改</p> <p><code>xlsx-style</code>用起来很麻烦，因为是基于很旧版本的<code>xlsx</code>，许多api不支持，这里就不写用法了，不推荐使用</p> <h3 id="xlsx"><a href="#xlsx" class="header-anchor">#</a> xlsx</h3> <p>下面写一下<code>xlsx</code>的用法示例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// excel.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> saveAs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'file-saver'</span>
<span class="token keyword">import</span> <span class="token constant">XLSX</span> <span class="token keyword">from</span> <span class="token string">'xlsx'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">exportJSONToExcel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  data<span class="token punctuation">,</span>
  filename <span class="token operator">=</span> <span class="token string">'example'</span><span class="token punctuation">,</span>
  option <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> wb <span class="token operator">=</span> <span class="token punctuation">{</span>
    SheetNames<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    Sheets<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// Props: { // 属性</span>
    <span class="token comment">//   Subject: '*',</span>
    <span class="token comment">//   Author: 'XHC'</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 数组 --&gt; 工作表数据格式</span>
  <span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">aoa_to_sheet</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token comment">// 合并单元格</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>merges<span class="token punctuation">)</span> ws<span class="token punctuation">[</span><span class="token string">'!merges'</span><span class="token punctuation">]</span> <span class="token operator">=</span> option<span class="token punctuation">.</span>merges
  <span class="token keyword">const</span> sheetName <span class="token operator">=</span> <span class="token string">'sheet-1'</span>
  wb<span class="token punctuation">.</span>SheetNames<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sheetName<span class="token punctuation">)</span>
  ws<span class="token punctuation">.</span>Sheets<span class="token punctuation">[</span>sheetName<span class="token punctuation">]</span> <span class="token operator">=</span> ws
  <span class="token keyword">const</span> wbout <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>wb<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    bookType<span class="token punctuation">:</span> <span class="token string">'xlsx'</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token string">'array'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">saveAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>wbout<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'application/octet-stream'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.xlsx</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上函数将二维数组转化成excel里的表，只生成一个<code>sheet</code>，且无任何样式设置，实际上社区版的<code>xlsx</code>有设置单元格宽度等功能</p> <p>在<code>protobi/js-xlsx/issues/90</code>里<code>xlsx-style</code>的开发者说明了不维护的原因以及替代方案，再加上评论里还有人推荐了另一个库，现有两个选择</p> <ol><li><p><code>msexcel-builder</code></p> <p><code>xlsx-style</code>开发者维护的只有生成xlsx文件功能的轻量级库</p></li> <li><p><code>exceljs</code></p> <p>功能和<code>xlsx</code>类似，支持样式设置</p></li></ol> <p>两者对比，前者十几个star，一年多没更新，开发者好像又弃坑了...后者4.7k个star，一直在维护，当然选第二个</p> <h3 id="exceljs"><a href="#exceljs" class="header-anchor">#</a> exceljs</h3> <p><code>exceljs</code>用起来有一点点别扭，直接用的话设置样式很烦，最好手动封装一下，目前的导出需要的功能有加粗、边框、合并、水平垂直居中等</p> <p>在设计封装时，考虑把数据和样式分开，传入参数的字段有</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">exportJSONToExcel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 导出文件名</span>
  name <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 纯数据的二维数组，值为简单类型</span>
  data<span class="token punctuation">,</span>
  <span class="token comment">// 合并选项 三维数组，左上角起点+右下角终点</span>
  <span class="token comment">// [[[x1,y1], [x2, y2]],...]</span>
  merge <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 加粗选项 二维数组 单元格位置</span>
  <span class="token comment">// [[x,y],...]</span>
  bold <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 边框选项 - 暂定</span>
  <span class="token comment">// [[{ </span>
  <span class="token comment">//   range: [[x1,y1],[x2,y2]], // 区域</span>
  <span class="token comment">//   type: 'thin',  // 边框类型</span>
  <span class="token comment">//   color: '#ff0000' // 边框颜色</span>
  <span class="token comment">// }]]</span>
  border <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>先生成一个纯数据的表</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// exportJSONToExcel</span>
<span class="token keyword">let</span> workbook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Excel<span class="token punctuation">.</span>Workbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 可添加一些额外信息 如作者、公司等</span>
workbook<span class="token punctuation">.</span>creator <span class="token operator">=</span> <span class="token string">'XHC'</span> 
<span class="token comment">// 新建sheet</span>
<span class="token keyword">let</span> sheet <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">addWorksheet</span><span class="token punctuation">(</span><span class="token string">'sheet-1'</span><span class="token punctuation">)</span>
<span class="token comment">// 添加纯数据</span>
sheet<span class="token punctuation">.</span><span class="token function">addRows</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token comment">// 导出</span>
workbook<span class="token punctuation">.</span>xlsx<span class="token punctuation">.</span><span class="token function">writeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">saveAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>buffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.xlsx</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>so easy，纯数据的导出不论是<code>xlsx</code>还是<code>exceljs</code>都很简单，接下来是给单元格附加样式</p> <h4 id="bold"><a href="#bold" class="header-anchor">#</a> bold</h4> <p>样式的操作放在数据添加完成后，导出前，先做个加粗</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// exportJSONToExcel</span>
bold <span class="token operator">=</span> bold<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 遍历单元格</span>
data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rowData<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> row <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">getRow</span><span class="token punctuation">(</span>r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  rowData<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cellData<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cell <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> rc <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>r<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>c<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token comment">// 加粗</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bold<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> bold<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">boldItem</span> <span class="token operator">=&gt;</span> boldItem <span class="token operator">===</span> rc<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cell<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token punctuation">{</span>
          bold<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        bold<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>辨别加粗单元格是通过把位置转化成字符串再比对的方法实现的，感觉还好</p> <h4 id="merge"><a href="#merge" class="header-anchor">#</a> merge</h4> <p>然后是合并，合并是通过<code>worksheet.mergeCells('A4:B5')</code>实现的，所以需要一个数组下标转excel坐标<code>ABC</code>的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 0 -&gt; A  25 -&gt; Z</span>
<span class="token comment">// 26 -&gt; AA  100 -&gt; CW</span>
<span class="token keyword">function</span> <span class="token function">numToABC</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> str <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> num <span class="token operator">%</span> <span class="token number">26</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>num <span class="token operator">/</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
  str <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">65</span><span class="token punctuation">)</span> <span class="token operator">+</span> str
  <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> str
  <span class="token keyword">return</span> <span class="token function">numToABC</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> str<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过递归实现，需要注意的是数组是从0开始的，而excel是从1开始的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// exportJSONToExcel</span>
<span class="token comment">// [[[x1,y1], [x2, y2]],...]</span>
<span class="token keyword">let</span> mergeContent <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
merge<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">arr</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  mergeContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  sheet<span class="token punctuation">.</span><span class="token function">mergeCells</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">numToABC</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">numToABC</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 单元格遍历内部 和bold平级</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mergeContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> mergeContent<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">mergeItem</span> <span class="token operator">=&gt;</span> mergeItem <span class="token operator">===</span> rc<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cell<span class="token punctuation">.</span>alignment <span class="token operator">=</span> <span class="token punctuation">{</span>
      vertial<span class="token punctuation">:</span> <span class="token string">'middle'</span><span class="token punctuation">,</span>
      horizontal<span class="token punctuation">:</span> <span class="token string">'center'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>数组的xy与excel的xy是反的，也需要注意一下</p> <p>还有，如果只是合并的话，里面的内容是不会水平垂直居中的，最好把内容放在左上角单元格里，在遍历单元格时，附上居中样式，完美！</p> <p>还有一个加边框的功能，先留着吧，大致思路是传参和merge类似，描述区域的数组，再加边框的颜色和形状字段，在遍历单元格的时候分辨四个边分别附上各自的边框样式，OVER！</p> <p>本来计划周三写完的，导出excel就用<code>xlsx</code>，谁能想到中途改成了<code>exceljs</code>，再加上其他杂七杂八的事情，一拖就到周末了。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>导出图片很简单，导出excel土豪可以买<code>xlsx</code>的完整版，平民推荐<code>exceljs</code>，上文只是对几个功能做了点封装，但也限制了其他功能的使用，最佳实践应该是在兼容原有api正常使用的情况下，扩展一些简化版的api，以后用到的时候在写吧。</p> <p>导出作为一个相对隐蔽的辅助功能，使用的人可能百分之一都不到，就算用，也没多少人在乎里面的样式是什么，有数据就行了。</p> <p>但还是尽量做了，毕竟<code>html2canvas</code>、<code>xlsx</code>、<code>xlsx-style</code>、<code>excel</code>，维护这些库的开发者们至少上百人，跨度也差不多有十来年，支持他们的方法除了加入他们、提pr、提issue，也就只有使用他们的代码了。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">修改于:</span> <span class="time">12/8/2019, 8:06:45 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/essay/Highcharts多图联动实现及优化.html" class="prev">Highcharts多图联动实现及优化</a></span> <span class="next"><a href="/essay/Highcharts矩形树图的自定义布局方法.html">Highcharts矩形树图的自定义布局方法</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3b644823.js" defer></script><script src="/assets/js/2.e997199f.js" defer></script><script src="/assets/js/40.64191991.js" defer></script>
  </body>
</html>
